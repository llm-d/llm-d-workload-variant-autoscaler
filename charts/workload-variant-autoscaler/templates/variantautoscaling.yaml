{{- if .Values.va.enabled }}
apiVersion: llmd.ai/v1alpha1
# Single-variant autoscaling resource - create one VariantAutoscaling CR per variant
# This should only be created when the model is deployed and serving traffic
kind: VariantAutoscaling
metadata:
  # Name typically matches the Deployment name (Kubernetes DNS-1123 compliant)
  name: {{ printf "%s-decode" .Values.llmd.modelName }}
  namespace: {{ .Values.llmd.namespace }}
  labels:
    inference.optimization/acceleratorName: {{ .Values.va.accelerator }}
spec:
  # Reference to the target Deployment to scale
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ printf "%s-decode" .Values.llmd.modelName }}

  # OpenAI API compatible name of the model
  modelID: {{ .Values.llmd.modelID | quote }}

  # Business identifier for this variant (model + accelerator + count combination)
  # Format: {modelID}-{accelerator}-{acceleratorCount}
  # May contain slashes, dots, mixed case (not restricted to DNS-1123)
  variantID: {{ .Values.va.variantID | quote }}

  # Accelerator type for this variant
  accelerator: {{ .Values.va.accelerator | quote }}

  # Number of accelerator units per replica
  acceleratorCount: {{ .Values.va.acceleratorCount }}

  # Cost per replica for this variant (optional, defaults to "10")
  {{- if .Values.va.variantCost }}
  variantCost: {{ .Values.va.variantCost | quote }}
  {{- end }}

  # SLO configuration reference
  sloClassRef:
    name: premium-slo
    key: opt-125m

  # Performance profile for this specific variant
  variantProfile:
    perfParms:
      decodeParms:
        # Decode parameters for ITL equation: itl = alpha + beta * maxBatchSize
        alpha: {{ .Values.va.perfParms.decodeParms.alpha | quote }}
        beta: {{ .Values.va.perfParms.decodeParms.beta | quote }}
      prefillParms:
        # Prefill parameters for TTFT equation: ttft = gamma + delta * tokens * maxBatchSize
        gamma: {{ .Values.va.perfParms.prefillParms.gamma | quote }}
        delta: {{ .Values.va.perfParms.prefillParms.delta | quote }}
    maxBatchSize: {{ .Values.va.maxBatchSize }}
{{- end }}